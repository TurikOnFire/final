<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<header >
    <h1>FINAL PROJECT</h1>
    <nav>
        <a th:href="@{/}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a sec:authorize="!isAuthenticated()" th:href="@{/login}">–í–æ–π—Ç–∏</a>
        <a th:if="${#authorization.expression('isAuthenticated()')}" th:href="@{/logout}">–í—ã–π—Ç–∏</a>
    </nav>
</header>

<main>
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã</h2>
    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
        <span th:text="${#authentication.name}"></span>
    </p>

    <div>
        <div class="d-flex flex-row">
            <H1>USERS</H1>
            <H1><a href="#"></a></H1>
        </div>
        <table class="table">
            <tr>
                <th>User Id</th>
                <th>–õ–æ–≥–∏–Ω</th>
                <th>–ü–∞—Ä–æ–ª—å</th>
                <th>–ü–æ—á—Ç–∞</th>
                <th>–†–æ–ª—å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>

            <tr th:each="user : ${users}">
                <td th:text="${user.id}"></td>
                <td th:text="${user.username}"></td>
                <td th:text="${user.password}"></td>
                <td th:text="${user.email}"></td>
                <td th:text="${user.role}"></td>
                <td>
                    <div class="d-flex flex-row gap-3">
                        <div>
                            <a th:href="@{/users/{id}(id=${user.id})}" class="btn btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
                        </div>
                        <div>
                            <form th:action="@{/users/deleteuser/{id} (id=${user.id})}" method="post">
                                <button class="btn btn-danger" style="background-color: red" type="submit">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                            </form>
                        </div>
                    </div>
                </td>
            </tr>
        </table>

        <br>

        <H1>TASKS</H1>
        <H1><form th:action="@{/users/createtask}" method="post">
                <button class="btn btn-primary" style="width:50px" type="submit">+</button>
        </form></H1>
        <table class="table">
            <tr>
                <th>Task Id</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</th>
                <th>–î–µ–¥–ª–∞–π–Ω</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>

            <tr th:each="task : ${tasks}" th:data-id="${task.id}">
                <td th:text="${task.id}"></td>
                <td class="editable" data-field="title" th:text="${task.title}"></td>
                <td class="editable" data-field="description" th:text="${task.description}"></td>
                <td class="editable" data-field="deadline" th:text="${task.deadline}"></td>
                <td class="editable" data-field="status" th:text="${task.status}"></td>
                <td class="editable-user"
                    data-field="userId"
                    th:data-current-user-id="${task.user.id}">
                    <span th:text="${task.user.username}"></span>
                </td>

                <td>
                    <div class="d-flex flex-row gap-3">
                        <div>
                        <form th:action="@{/users/updatetask/{id}(id=${task.id})}"
                              method="post">
                            <button type="submit" class="btn btn-primary">
                                –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                            </button>
                        </form>
                        </div>
                        <div><button type="button"
                                     onclick="editRow(this)"
                                     class="btn btn-warning edit-btn">
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button></div>
                        <div><button type="button"
                                     onclick="saveRow(this)"
                                     class="btn btn-success save-btn"
                                     style="display:none;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button></div>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <a th:href="@{/}" class="btn btn-primary w-25 m-1">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</a>

</main>

<footer>
    <p>¬©JavaRush. Arthur Kuzin. 2025 FINAL</p>
</footer>
<script th:inline="javascript">
    const users = [[${users}]];

    function editRow(btn) {
        const row = btn.closest("tr");

        // –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—è
        row.querySelectorAll(".editable").forEach(td => {
            const value = td.textContent.trim();
            const field = td.dataset.field;

            let inputType = "text";
            if (field === "deadline") inputType = "date";

            td.innerHTML =
                `<input type="${inputType}"
                        class="form-control"
                        value="${value}">`;
        });

        // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (select)
        const userTd = row.querySelector(".editable-user");
        const currentUserId = userTd.dataset.currentUserId;

        let selectHtml = `<select class="form-select">`;
        users.forEach(u => {
            const selected = u.id == currentUserId ? "selected" : "";
            selectHtml += `<option value="${u.id}" ${selected}>${u.username}</option>`;
        });
        selectHtml += `</select>`;

        userTd.innerHTML = selectHtml;

        btn.style.display = "none";
        row.querySelector(".save-btn").style.display = "inline-block";
    }
    function saveRow(btn) {
    const row = btn.closest("tr");
    const id = row.dataset.id;

    const data = { id: id };

    // –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—è
    row.querySelectorAll(".editable").forEach(td => {
        const field = td.dataset.field;
        const input = td.querySelector("input");
        if (input) {
            data[field] = input.value;
        }
    });

    // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const userTd = row.querySelector(".editable-user");
    const select = userTd.querySelector("select");
    if (select) {
        data["userId"] = select.value;
    }

    fetch("/users/edittask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(r => {
        if (!r.ok) throw new Error();

        // –æ–±–Ω–æ–≤–ª—è–µ–º UI
        row.querySelectorAll(".editable").forEach(td => {
            const input = td.querySelector("input");
            if (input) td.textContent = input.value;
        });

        const selectedOption = select.options[select.selectedIndex];
        userTd.innerHTML = `<span>${selectedOption.text}</span>`;
        userTd.dataset.currentUserId = select.value;

        btn.style.display = "none";
        row.querySelector(".edit-btn").style.display = "inline-block";
    })
    .catch(() => alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏"));
}
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
</body>
</html>
